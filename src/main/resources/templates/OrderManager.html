<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏ - Glamour</title>
    <link rel="stylesheet" th:href="@{/css/site.css}">
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
            min-height:100vh; padding-top:80px; color:#2d3748;
        }
        .container { max-width:1400px; margin:0 auto; padding:2rem; }

        .page-header { text-align:center; margin-bottom:3rem; color:#fff; }
        .page-title { font-size:3.5rem; font-weight:300; margin-bottom:1rem; text-shadow:0 4px 15px rgba(0,0,0,.2); position:relative; display:inline-block; }
        .page-title::before{content:'üë®‚Äçüíº'; position:absolute; left:-70px; top:50%; transform:translateY(-50%); font-size:2.5rem; animation:float 3s ease-in-out infinite;}
        .page-title::after{content:'üìä'; position:absolute; right:-70px; top:50%; transform:translateY(-50%); font-size:2.5rem; animation:float 3s ease-in-out infinite 1.5s;}
        @keyframes float{0%,100%{transform:translateY(-50%) rotate(0)}33%{transform:translateY(-60%) rotate(5deg)}66%{transform:translateY(-40%) rotate(-5deg)}}
        .page-subtitle{font-size:1.3rem; color:rgba(255,255,255,.9); font-weight:300;}

        .orders-controls{background:rgba(255,255,255,.95); border-radius:20px; padding:2rem; margin-bottom:2rem; box-shadow:0 15px 40px rgba(0,0,0,.1); backdrop-filter:blur(10px); border:1px solid rgba(255,255,255,.2);}
        .controls-grid{display:grid; grid-template-columns:2fr 1fr 1fr 1fr; gap:1.5rem; align-items:end;}
        .search-box,.filter-select{padding:1rem 1.5rem; border:2px solid #e2e8f0; border-radius:12px; font-size:1rem; background:#fff; transition:.3s;}
        .search-box:focus,.filter-select:focus{outline:none; border-color:#667eea; box-shadow:0 0 0 3px rgba(102,126,234,.1);}
        .filter-btn{padding:1rem 2rem; background:linear-gradient(135deg,#667eea,#764ba2); color:#fff; border:none; border-radius:12px; font-weight:600; cursor:pointer; transition:.3s; box-shadow:0 6px 20px rgba(102,126,234,.4);}
        .filter-btn:hover{transform:translateY(-2px); box-shadow:0 8px 25px rgba(102,126,234,.6);}

        .orders-stats{display:grid; grid-template-columns:repeat(4,1fr); gap:1.5rem; margin-bottom:2rem;}
        .stat-card{background:rgba(255,255,255,.95); padding:2rem; border-radius:16px; text-align:center; box-shadow:0 10px 30px rgba(0,0,0,.1); backdrop-filter:blur(10px); border:1px solid rgba(255,255,255,.2); transition:transform .3s; position:relative; overflow:hidden; animation:fadeInUp .8s ease-out;}
        .stat-card::before{content:''; position:absolute; top:0; left:0; right:0; height:4px; background:linear-gradient(90deg,#ff6b6b,#ffd93d,#4fd1c7,#667eea);}
        .stat-card:hover{transform:translateY(-5px);}
        .stat-icon{font-size:2.5rem; margin-bottom:1rem; display:block;}
        .stat-number{font-size:2.2rem; font-weight:700; background:linear-gradient(135deg,#667eea,#764ba2); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; display:block; margin-bottom:.5rem;}
        .stat-label{color:#718096; font-size:.95rem; font-weight:500;}

        .orders-list{display:flex; flex-direction:column; gap:1.5rem;}
        .order-card{background:rgba(255,255,255,.95); border-radius:20px; padding:2rem; box-shadow:0 15px 40px rgba(0,0,0,.1); backdrop-filter:blur(10px); border:1px solid rgba(255,255,255,.2); transition:.3s; position:relative; overflow:hidden; animation:fadeInUp .6s ease-out;}
        .order-card::before{content:''; position:absolute; left:0; top:0; bottom:0; width:6px; background:linear-gradient(135deg,#667eea,#764ba2);}
        .order-card:hover{transform:translateY(-5px); box-shadow:0 20px 50px rgba(0,0,0,.15);}

        .order-header{display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:1.5rem; padding-bottom:1.5rem; border-bottom:2px solid #f7fafc;}
        .order-info{display:flex; flex-direction:column; gap:.5rem;}
        .order-number{font-size:1.4rem; font-weight:700; color:#2d3748;}
        .order-date{color:#718096;}
        .order-user{color:#4a5568;} .order-user strong{color:#2d3748;}

        .status-section{display:flex; flex-direction:column; gap:1rem; align-items:flex-end;}
        .order-status{padding:.6rem 1.5rem; border-radius:25px; font-weight:600; font-size:.9rem; display:inline-flex; align-items:center; gap:.5rem;}
        .status-processing{background:#fff3cd; color:#856404; border:1px solid #ffeaa7;}
        .status-ready{background:#d1ecf1; color:#0c5460; border:1px solid #bee5eb;}
        .status-completed{background:#d4edda; color:#155724; border:1px solid #c3e6cb;}

        .status-controls{display:flex; gap:1rem; align-items:center;}
        .status-select{padding:.7rem 1rem; border:2px solid #e2e8f0; border-radius:8px; font-size:.9rem; background:#fff; min-width:180px;}
        .status-select:focus{outline:none; border-color:#667eea;}
        .update-btn{padding:.7rem 1.5rem; background:linear-gradient(135deg,#48bb78,#38a169); color:#fff; border:none; border-radius:8px; font-weight:600; cursor:pointer; transition:.3s;}
        .update-btn:hover{background:linear-gradient(135deg,#38a169,#2f855a); transform:translateY(-2px);}
        .update-btn:disabled{background:#a0aec0; cursor:not-allowed; transform:none;}

        .order-details{display:grid; grid-template-columns:2fr 1fr 1fr; gap:2rem; margin-bottom:1.5rem;}
        .order-items{display:flex; flex-direction:column; gap:1rem;}
        .order-item{display:flex; gap:1rem; align-items:center; padding:1rem; background:#f7fafc; border-radius:10px;}
        .item-image{width:70px; height:70px; border-radius:10px; object-fit:cover; border:2px solid #f7fafc; box-shadow:0 4px 12px rgba(0,0,0,.1);}
        .item-placeholder{width:70px; height:70px; border-radius:10px; background:linear-gradient(135deg,#667eea,#764ba2); display:flex; align-items:center; justify-content:center; color:#fff; font-size:1.2rem; border:2px solid #f7fafc;}
        .item-info{flex:1;}
        .item-name{font-weight:600; margin-bottom:.3rem;}
        .item-details{color:#718096; font-size:.9rem;}
        .items-count{align-self:center; color:#718096; font-weight:500;}
        .order-total{text-align:center; align-self:center;}
        .total-amount{font-size:1.8rem; font-weight:700; background:linear-gradient(135deg,#e53e3e,#dd6b20); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; display:block;}
        .total-label{color:#718096; font-size:.9rem;}

        .empty-orders{text-align:center; padding:6rem 3rem; background:rgba(255,255,255,.95); border-radius:25px; box-shadow:0 25px 60px rgba(0,0,0,.15); backdrop-filter:blur(10px); border:1px solid rgba(255,255,255,.2); margin:2rem 0;}
        .empty-icon{font-size:8rem; margin-bottom:2rem; background:linear-gradient(135deg,#667eea,#764ba2); -webkit-background-clip:text; -webkit-text-fill-color:transparent; filter:drop-shadow(0 8px 20px rgba(0,0,0,.1));}
        .empty-title{font-size:2.5rem; margin-bottom:1.5rem; color:#2d3748; font-weight:300;}
        .empty-message{color:#718096; margin-bottom:3rem; font-size:1.2rem; line-height:1.6;}

        .notification{position:fixed; top:100px; right:20px; padding:1rem 1.5rem; border-radius:10px; color:#fff; font-weight:600; box-shadow:0 10px 30px rgba(0,0,0,.2); z-index:1000; transform:translateX(400px); transition:transform .3s;}
        .notification.show{transform:translateX(0);}
        .notification.success{background:linear-gradient(135deg,#48bb78,#38a169);}
        .notification.error{background:linear-gradient(135deg,#f56565,#e53e3e);}

        @keyframes fadeInUp{from{opacity:0; transform:translateY(30px);} to{opacity:1; transform:translateY(0);}}

        @media (max-width:1200px){
            .controls-grid{grid-template-columns:1fr 1fr;}
            .order-details{grid-template-columns:1fr; gap:1.5rem;}
            .status-controls{flex-direction:column;} .status-select{min-width:100%;}
        }
        @media (max-width:768px){
            .container{padding:1rem;}
            .page-title{font-size:2.5rem;}
            .page-title::before,.page-title::after{display:none;}
            .orders-stats{grid-template-columns:repeat(2,1fr);}
            .order-header{flex-direction:column; gap:1rem;}
            .order-item{flex-direction:column; text-align:center;}
        }
        @media (max-width:480px){
            .orders-stats{grid-template-columns:1fr;}
            .controls-grid{grid-template-columns:1fr;}
        }
    </style>
</head>
<body>
<div th:replace="~{fragments :: headerFragment(role=${role}, username=${username})}"></div>

<div class="container">
    <div class="page-header">
        <h1 class="page-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏</h1>
        <p class="page-subtitle">–ü—Ä–æ—Å–º–æ—Ç—Ä –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞–º–∏ –≤—Å–µ—Ö –∑–∞–∫–∞–∑–æ–≤</p>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="orders-stats">
        <div class="stat-card">
            <span class="stat-icon">üì¶</span>
            <span class="stat-number" th:text="${ordersTotal}">0</span>
            <span class="stat-label">–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</span>
        </div>

        <div class="stat-card">
            <span class="stat-icon">‚è≥</span>
            <span class="stat-number" th:text="${ordersProcessing}">0</span>
            <span class="stat-label">–°–æ–±–∏—Ä–∞—é—Ç—Å—è</span>
        </div>

        <div class="stat-card">
            <span class="stat-icon">üöö</span>
            <span class="stat-number" th:text="${ordersReady}">0</span>
            <span class="stat-label">–ì–æ—Ç–æ–≤—ã –∫ –≤—ã–¥–∞—á–µ</span>
        </div>

        <div class="stat-card">
            <span class="stat-icon">‚úÖ</span>
            <span class="stat-number" th:text="${ordersCompleted}">0</span>
            <span class="stat-label">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>
        </div>
    </div>

    <div class="orders-controls">
        <div class="controls-grid">
            <input id="ordersSearch"  type="text" class="search-box" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –Ω–æ–º–µ—Ä—É –∑–∞–∫–∞–∑–∞ –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é...">
            <select class="filter-select" id="statusFilter">
                <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                <option value="–°–æ–±–∏—Ä–∞–µ—Ç—Å—è">–°–æ–±–∏—Ä–∞–µ—Ç—Å—è</option>
                <option value="–ì–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ">–ì–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ</option>
                <option value="–ó–∞–≤–µ—Ä—à–µ–Ω">–ó–∞–≤–µ—Ä—à–µ–Ω</option>
            </select>
            <select class="filter-select" id="dateFilter">
                <option value="">–ó–∞ –≤—Å–µ –≤—Ä–µ–º—è</option>
                <option value="week">–ó–∞ –Ω–µ–¥–µ–ª—é</option>
                <option value="month">–ó–∞ –º–µ—Å—è—Ü</option>
                <option value="year">–ó–∞ –≥–æ–¥</option>
            </select>
        </div>
    </div>

    <div class="orders-list" th:if="${!#lists.isEmpty(orders)}">
        <div class="order-card"
             th:each="o : ${orders}"
             th:attr="
         data-order-id=${o.orderId},
         data-user=${o.user != null ? o.user.login : ''},
         data-status=${o.orderStatus != null ? o.orderStatus.orderStatus : ''},
         data-date-iso=${o.orderDate != null ? #dates.format(o.orderDate,'yyyy-MM-dd') : ''}">

        <div class="order-header">
                <div class="order-info">
                    <div class="order-number">–ó–∞–∫–∞–∑ #<span th:text="${o.orderId}">0</span></div>
                    <div class="order-date">
                        –°–æ–∑–¥–∞–Ω:
                        <span th:text="${o.orderDate != null ? #dates.format(o.orderDate,'dd.MM.yyyy HH:mm') : '-'}">‚Äî</span>
                    </div>
                    <div class="order-user">
                        –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <strong th:text="${o.user != null ? o.user.login : '‚Äî'}">‚Äî</strong>
                    </div>
                </div>

                <div class="order-status"
                     th:classappend="${
                        #strings.equalsIgnoreCase(o.orderStatus.orderStatus,'–°–æ–±–∏—Ä–∞–µ—Ç—Å—è') ? ' status-processing' :
                        (#strings.equalsIgnoreCase(o.orderStatus.orderStatus,'–ì–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ') ? ' status-ready' :
                        (#strings.equalsIgnoreCase(o.orderStatus.orderStatus,'–ó–∞–≤–µ—Ä—à–µ–Ω') ? ' status-completed' : ''))
                     }">
                    <span th:text="${o.orderStatus.orderStatus}">–°—Ç–∞—Ç—É—Å</span>
                </div>

                <div class="status-controls">
                    <form th:action="@{/manager/orders/{id}/status(id=${o.orderId})}" method="post">
                        <select class="status-select" name="statusId">
                            <option th:each="s : ${statuses}"
                                    th:value="${s.ordersStatusId}"
                                    th:text="${s.orderStatus}"
                                    th:selected="${o.orderStatus != null and s.ordersStatusId == o.orderStatus.ordersStatusId}">
                            </option>
                        </select>
                        <button class="update-btn" type="submit">–û–±–Ω–æ–≤–∏—Ç—å</button>
                    </form>
                </div>
            </div>

            <div class="order-details">

                <div class="order-items">
                    <div th:each="it : ${o.items}" class="order-item">
                        <img class="item-image"
                             th:if="${it.cosmeticItem != null && it.cosmeticItem.imagePath != null}"
                             th:src="@{${it.cosmeticItem.imagePath}}"
                             alt="item"/>
                        <div class="item-placeholder"
                             th:if="${it.cosmeticItem == null || it.cosmeticItem.imagePath == null}">üß¥</div>

                        <div class="item-info">
                            <div class="item-name"
                                 th:text="${it.cosmeticItem != null ? it.cosmeticItem.itemName : '–¢–æ–≤–∞—Ä'}">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</div>
                            <div class="item-details">
                                –ö–æ–ª-–≤–æ: <span th:text="${it.quantity}">1</span> √ó
                                <span th:text="${#numbers.formatDecimal(it.price, 1, 'POINT', 2, 'COMMA')}">0.00</span> ‚ÇΩ
                            </div>
                        </div>
                    </div>
                </div>

                <div class="items-count">
                    –ü–æ–∑–∏—Ü–∏–∏: <span th:text="${o.items != null ? o.items.size() : 0}">0</span>
                </div>

                <div class="order-total">
                    <span class="total-amount"
                          th:text="${#numbers.formatDecimal(o.total, 1, 'POINT', 2, 'COMMA')}">0.00</span> ‚ÇΩ
                    <div class="total-label">–ò—Ç–æ–≥–æ</div>
                </div>
            </div>
        </div>
    </div>

    <div class="empty-orders" th:if="${#lists.isEmpty(orders)}">
        <div class="empty-icon">üì¶</div>
        <h2 class="empty-title">–ó–∞–∫–∞–∑–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h2>
        <p class="empty-message">–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –≤–∞—à–∏–º —Ñ–∏–ª—å—Ç—Ä–∞–º.</p>
    </div>
</div> <!-- .container -->

<!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ -->
<div id="notification" class="notification"></div>
<script>
    (function () {
      const qInput = document.getElementById('ordersSearch');
      const stSel  = document.getElementById('statusFilter');
      const dtSel  = document.getElementById('dateFilter');

      const toNorm = s => (s || '').toString().toLowerCase().trim().replace(/—ë/g,'–µ').replace(/\s+/g,' ');

      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ä—É—Å—Å–∫–∏–π —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—É—Å–∞ ‚Üí –∫–ª—é—á: processing | ready | completed
      function statusKey(s){
        const t = toNorm(s);
        if (t.includes('—Å–æ–±–∏—Ä–∞')) return 'processing';
        if (t.includes('–≥–æ—Ç–æ–≤') && t.includes('–≤—ã–¥–∞—á')) return 'ready';
        if (t.includes('–∑–∞–≤–µ—Ä—à')) return 'completed';
        return ''; // –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ
      }

      function cutoffForPeriod(val){
        const now = new Date();
        const d = new Date(now);
        if (val === 'week')  d.setDate(now.getDate() - 7);
        if (val === 'month') d.setMonth(now.getMonth() - 1);
        if (val === 'year')  d.setFullYear(now.getFullYear() - 1);
        return val ? d : null;
      }

      function parseISO(iso){
        if (!iso) return null;
        const [y,m,d] = iso.split('-').map(Number);
        if (!y || !m || !d) return null;
        return new Date(y, m - 1, d, 23, 59, 59);
      }

      window.applyFilters = function applyFilters(){
        const q      = toNorm(qInput?.value);
        const stValK = statusKey(stSel?.value);   // –∫–ª—é—á –∏–∑ —Å–µ–ª–µ–∫—Ç–∞
        const period = dtSel?.value || '';
        const cutoff = cutoffForPeriod(period);

        const cards = document.querySelectorAll('.orders-list .order-card');
        cards.forEach(card => {
          const id      = toNorm(card.dataset.orderId);
          const user    = toNorm(card.dataset.user);
          const statusK = statusKey(card.dataset.status);  // –∫–ª—é—á –∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏
          const dt      = parseISO(card.dataset.dateIso);

          const qOk  = !q || id.includes(q) || user.includes(q);
          const stOk = !stValK || statusK === stValK;
          const dtOk = !cutoff || (dt && dt >= cutoff);

          card.style.display = (qOk && stOk && dtOk) ? '' : 'none';
        });

        const anyVisible = Array.from(document.querySelectorAll('.orders-list .order-card'))
                                .some(c => c.style.display !== 'none');
        const empty = document.querySelector('.empty-orders');
        if (empty) empty.style.display = anyVisible ? 'none' : '';
      };

      if (qInput) qInput.addEventListener('input',  applyFilters, {passive:true});
      if (stSel)  stSel.addEventListener('change', applyFilters, {passive:true});
      if (dtSel)  dtSel.addEventListener('change', applyFilters, {passive:true});
      document.addEventListener('DOMContentLoaded', applyFilters);
    })();
</script>


</body>
</html>

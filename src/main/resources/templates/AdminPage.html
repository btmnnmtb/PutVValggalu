<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ - Glamour</title>
    <link rel="stylesheet" th:href="@{/css/site.css}">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding-top: 80px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .page-header {
            text-align: center;
            margin-bottom: 3rem;
            color: #2d3748;
        }

        .page-title {
            font-size: 3rem;
            font-weight: 300;
            margin-bottom: 1rem;
            position: relative;
            display: inline-block;
        }

        .page-title::before {
            content: '';
            position: absolute;
            left: -70px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 2.5rem;
        }

        .page-subtitle {
            font-size: 1.3rem;
            color: #718096;
            font-weight: 300;
        }

        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            display: block;
        }

        .stat-number {
            font-size: 2.2rem;
            font-weight: 700;
            color: #2d3748;
            display: block;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #718096;
            font-size: 0.95rem;
            font-weight: 500;
        }

        /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .admin-controls {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 15px 40px rgba(0,0,0,0.1);
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .control-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem 1rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            text-decoration: none;
            text-align: center;
        }

        .control-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }

        .control-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        /* –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π */
        .users-section {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 15px 40px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-title::before {
            content: 'üë•';
            font-size: 1.5rem;
        }

        .search-box {
            width: 100%;
            padding: 1rem 1.5rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            background: white;
            transition: all 0.3s ease;
            margin-bottom: 1.5rem;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.5rem;
        }

        .users-table th {
            background: #f7fafc;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #4a5568;
            border-bottom: 2px solid #e2e8f0;
        }

        .users-table td {
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .user-row:hover {
            background: #f7fafc;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 0.5rem;
            vertical-align: middle;
        }

        .user-placeholder {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
            margin-right: 0.5rem;
            vertical-align: middle;
        }

        .user-role {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .role-admin {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .role-user {
            background: #e3f2fd;
            color: #1565c0;
        }

        .role-manager {
            background: #fff3e0;
            color: #ef6c00;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }

        .btn-edit {
            background: #fff3e0;
            color: #ef6c00;
            border: 1px solid #ffcc80;
        }

        .btn-edit:hover {
            background: #ffcc80;
        }

        .btn-delete {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }

        .btn-delete:hover {
            background: #ffcdd2;
        }

        .btn-add {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .btn-add:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            position: relative;
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f7fafc;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2d3748;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #718096;
        }

        .close-btn:hover {
            color: #2d3748;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #4a5568;
        }

        .form-input {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-select {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .form-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }

        .btn-cancel {
            background: #f7fafc;
            color: #4a5568;
            border: 1px solid #e2e8f0;
        }

        .btn-cancel:hover {
            background: #e2e8f0;
        }

        .btn-save {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-save:hover {
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        .logs-section .section-title::before {
    content: 'üìú';
}

.logs-header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.logs-meta {
    font-size: 0.85rem;
    color: #718096;
}

.logs-search {
    max-width: 360px;
    margin-bottom: 0;
}

.logs-table {
    font-size: 0.9rem;
}

.logs-table thead th[data-sort] {
    cursor: pointer;
    position: relative;
    user-select: none;
}

.logs-table thead th[data-sort]::after {
    content: '‚áÖ';
    font-size: 0.7rem;
    opacity: 0.4;
    margin-left: 0.25rem;
}

.logs-table thead th[data-sort].sort-asc::after {
    content: '‚ñ≤';
    opacity: 0.8;
}

.logs-table thead th[data-sort].sort-desc::after {
    content: '‚ñº';
    opacity: 0.8;
}

.logs-table tbody tr:nth-child(even) {
    background: #f9fafb;
}

.logs-table tbody tr:hover {
    background: #eef2ff;
}

.log-action-pill {
    display: inline-flex;
    align-items: center;
    padding: 0.2rem 0.7rem;
    border-radius: 999px;
    font-size: 0.8rem;
    font-weight: 600;
    background: #e0e7ff;
    color: #3730a3;
}

.log-user-pill {
    display: inline-flex;
    align-items: center;
    padding: 0.2rem 0.6rem;
    border-radius: 999px;
    font-size: 0.8rem;
    background: #eef2ff;
    color: #1f2937;
}

.log-user-pill::before {
    content: 'üë§';
    font-size: 0.9rem;
    margin-right: 0.25rem;
}

.log-details {
    max-width: 420px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 0.8rem;
    color: #4b5563;
    cursor: pointer;
}

.log-details.expanded {
    white-space: pre-wrap;
    max-height: 260px;
    overflow: auto;
    background: #f9fafb;
    padding: 0.5rem;
    border-radius: 0.5rem;
}

.log-details-hint {
    font-size: 0.75rem;
    color: #a0aec0;
    margin-top: 0.2rem;
}

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 1200px) {
            .admin-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .page-title {
                font-size: 2.2rem;
            }

            .page-title::before {
                display: none;
            }

            .users-table {
                display: block;
                overflow-x: auto;
            }

            .action-buttons {
                flex-direction: column;
            }

            .modal-content {
                width: 95%;
                padding: 1.5rem;
            }
        }

        @media (max-width: 480px) {
            .admin-stats {
                grid-template-columns: 1fr;
            }

            .controls-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<div th:replace="~{fragments :: headerFragment(role=${role}, username=${username})}"></div>

<div class="container">
    <div class="page-header">
        <h1 class="page-title">–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h1>
        <p class="page-subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ —Å–∏—Å—Ç–µ–º–æ–π</p>
    </div>

    <div class="admin-stats">
        <div class="stat-card">
            <span class="stat-icon">üë•</span>
            <span class="stat-number" th:text="${usersCount}">0</span>
            <span class="stat-label">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</span>
        </div>

        <div class="stat-card">
            <span class="stat-icon">üì¶</span>
            <span class="stat-number" th:text="${ordersCount}">0</span>
            <span class="stat-label">–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</span>
        </div>

        <div class="stat-card">
            <span class="stat-icon">üí∞</span>
            <span class="stat-number"
                  th:text="${#numbers.formatDecimal(totalRevenue, 0, 'COMMA', 2, 'POINT') + ' ‚ÇΩ'}">0</span>
            <span class="stat-label">–û–±—â–∏–π –¥–æ—Ö–æ–¥</span>
        </div>
    </div>

    <div class="admin-controls">
        <div class="controls-grid">
            <button id="btnAddUser" class="control-btn" type="button" onclick="openAddUserModal()">
                <span class="control-icon">‚ûï</span>
                –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            </button>
            <a  id="btnExportCsv" href="/admin/reports/orders.csv" class="control-btn">
                <span class="control-icon">‚¨áÔ∏è</span>
                –≠–∫—Å–ø–æ—Ä—Ç (CSV, –ø–æ–º–µ—Å—è—á–Ω–æ)
            </a>
        </div>
    </div>

    <!-- –û–¥–∏–Ω –≥—Ä–∞—Ñ–∏–∫: –î–æ—Ö–æ–¥ –ø–æ –º–µ—Å—è—Ü–∞–º -->
    <div class="users-section">
        <h2 class="section-title">–î–æ—Ö–æ–¥ –ø–æ –º–µ—Å—è—Ü–∞–º</h2>
        <canvas id="revenueChart" height="120"></canvas>
    </div>


    <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
    <div class="users-section">
        <h2 class="section-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h2>

        <input type="text" class="search-box" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π..." oninput="filterUsers(this.value)">

        <table class="users-table">
            <thead>
            <tr>
                <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                <th>–†–æ–ª—å</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
            </thead>
            <tbody id="usersTbody">
            <tr class="user-row" th:each="user : ${users}">
                <td>
                    <div class="user-placeholder">üë§</div>
                    <span th:text="${user.login}">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</span>
                </td>
                <td>
          <span th:classappend="'user-role ' +
              (${#strings.equalsIgnoreCase(user.role.roleName,'ADMIN')} ? 'role-admin' :
              (${#strings.equalsIgnoreCase(user.role.roleName,'MANAGER')} ? 'role-manager' : 'role-user'))"
                th:text="${user.role.roleName}">–†–æ–ª—å</span>
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-edit"
                                th:attr="data-id=${user.userId},
                     data-username=${user.login},
                     data-role=${user.role.roleName}"
                                type="button"
                                onclick="onEditClick(this)">
                            ‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å
                        </button>
                        <form th:action="@{/admin/users/delete/{id}(id=${user.userId})}" method="post"
                              onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è &laquo;' + this.dataset.username + '&raquo;?')"
                              th:attr="data-username=${user.login}">
                            <button class="btn btn-delete" type="submit">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                        </form>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>

        <button class="btn-add" type="button" onclick="openAddUserModal()">
            ‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        </button>
    </div>
</div>
<div class="users-section logs-section">
    <div class="logs-header-row">
        <h2 class="section-title">–ñ—É—Ä–Ω–∞–ª –¥–µ–π—Å—Ç–≤–∏–π</h2>
        <div class="logs-meta">
            –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: <span th:text="${#lists.size(logs)}">0</span>
        </div>
    </div>

    <input type="text"
           id="logSearch"
           class="search-box logs-search"
           placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –¥–µ–π—Å—Ç–≤–∏—è–º, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –∏ –¥–µ—Ç–∞–ª—è–º‚Ä¶"
           oninput="filterLogs(this.value)">

    <table class="users-table logs-table">
        <thead>
        <tr>
            <th data-sort="id">#</th>
            <th data-sort="date">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</th>
            <th data-sort="action">–î–µ–π—Å—Ç–≤–∏–µ</th>
            <th data-sort="user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
            <th data-sort="target">–¶–µ–ª—å (–Ω–∞–¥ –∫–µ–º)</th>
            <th>–î–µ—Ç–∞–ª–∏</th>
        </tr>
        </thead>
        <tbody id="logsTbody">
        <tr th:each="log : ${logs}">
            <td th:text="${log.logId}">1</td>

            <td class="log-date"
                th:attr="data-ts=${log.logDate != null ? log.logDate.toEpochMilli() : 0}"
                th:text="${log.formattedLogDate}">
                01.01.2025 12:00:00
            </td>

            <td>
                <span class="log-action-pill"
                      th:text="${log.action != null ? log.action.actionName : '‚Äî'}">
                    LOGIN
                </span>
            </td>

            <td>
                <span class="log-user-pill"
                      th:text="${log.user != null ? log.user.login : '‚Äî'}">
                    admin
                </span>
            </td>

            <td>
                <span class="log-user-pill"
                      th:text="${log.targetUser != null ? log.targetUser.login : '‚Äî'}">
                    user1
                </span>
            </td>

            <td>
                <div class="log-details"
                     th:text="${log.details}">

                </div>
            </td>
        </tr>
        </tbody>
    </table>
</div>

<div id="addUserModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
            <button class="close-btn" type="button" onclick="closeAddUserModal()">√ó</button>
        </div>

        <form th:action="@{/admin/users/add}" th:object="${createUser}" method="post" novalidate>


            <label class="form-label" for="username">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
            <input type="text" id="username" th:field="*{login}" class="form-input" required minlength="3" maxlength="20">
            <div class="error" th:if="${#fields.hasErrors('login')}" th:errors="*{login}"></div>

            <label class="form-label" for="password">–ü–∞—Ä–æ–ª—å</label>
            <input type="password" id="password" th:field="*{rawPassword}" class="form-input" required minlength="6" maxlength="20">
            <div class="error" th:if="${#fields.hasErrors('rawPassword')}" th:errors="*{rawPassword}"></div>

            <div class="form-group">
                <label class="form-label" for="role">–†–æ–ª—å</label>
                <select id="role" th:field="*{roleName}" class="form-select" required>
                    <option th:each="r : ${roles}" th:value="${r.roleName}" th:text="${r.roleName}"></option>
                </select>
                <div class="error" th:if="${#fields.hasErrors('roleName')}" th:errors="*{roleName}"></div>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn btn-cancel" onclick="closeAddUserModal()">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="btn btn-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </form>
    </div>
</div>

<div id="editUserModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
            <button class="close-btn" type="button" onclick="closeEditUserModal()">√ó</button>
        </div>

        <form th:action="@{/admin/users/update}" th:object="${editUser}" method="post" novalidate>


            <input type="hidden" th:field="*{userId}" id="editUserId">

            <label class="form-label" for="editUsername">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
            <input type="text" id="editUsername" th:field="*{login}" class="form-input" required minlength="3" maxlength="20">
            <div class="error" th:if="${#fields.hasErrors('login')}" th:errors="*{login}"></div>

            <label class="form-label" for="editPassword">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (–Ω–µ –æ–±—è–∑.)</label>
            <input type="password" id="editPassword" th:field="*{rawPassword}" class="form-input" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å" minlength="6" maxlength="20">
            <div class="error" th:if="${#fields.hasErrors('rawPassword')}" th:errors="*{rawPassword}"></div>

            <div class="form-group">
                <label class="form-label" for="editRole">–†–æ–ª—å</label>
                <select id="editRole" th:field="*{roleName}" class="form-select" required>
                    <option th:each="r : ${roles}" th:value="${r.roleName}" th:text="${r.roleName}"></option>
                </select>
                <div class="error" th:if="${#fields.hasErrors('roleName')}" th:errors="*{roleName}"></div>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn btn-cancel" onclick="closeEditUserModal()">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="btn btn-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
            </div>
        </form>
    </div>
</div>

<script>
    // ---- –ü–æ–∏—Å–∫ –ø–æ —Ç–∞–±–ª–∏—Ü–µ (–∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π) ----
    function filterUsers(q){
      q = (q || '').toLowerCase();
      const rows = document.querySelectorAll('#usersTbody .user-row');
      rows.forEach(tr=>{
        const text = tr.innerText.toLowerCase();
        tr.style.display = text.includes(q) ? '' : 'none';
      });
    }

    function openAddUserModal(){ document.getElementById('addUserModal').style.display = 'flex'; }
    function closeAddUserModal(){ document.getElementById('addUserModal').style.display = 'none'; }
    function openEditUserModal(){ document.getElementById('editUserModal').style.display = 'flex'; }
    function closeEditUserModal(){ document.getElementById('editUserModal').style.display = 'none'; }

    function onEditClick(btn){
      document.getElementById('editUserId').value   = btn.dataset.id;
      document.getElementById('editUsername').value = btn.dataset.username;
      document.getElementById('editRole').value     = btn.dataset.role;
      openEditUserModal();
    }



    function focusFirstError(modalId){
      const modal = document.getElementById(modalId);
      if (!modal) return;
      const errors = Array.from(modal.querySelectorAll('.error'));
      const firstErr = errors.find(e => (e.textContent || '').trim().length > 0);
      if (firstErr){
        const prev = firstErr.previousElementSibling;
        const input = prev && prev.matches('input,select,textarea')
          ? prev
          : modal.querySelector('input,select,textarea');
        if (input) input.focus();
      }
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
    window.onclick = function(e){
      const addM  = document.getElementById('addUserModal');
      const editM = document.getElementById('editUserModal');
      if (e.target === addM)  closeAddUserModal();
      if (e.target === editM) closeEditUserModal();
    }
</script>

<script th:inline="javascript">
    /*<![CDATA[*/
      document.addEventListener('DOMContentLoaded', function(){
        const openAdd  = /*[[${openAddModal}]]*/ false;
        const openEdit = /*[[${openEditModal}]]*/ false;

        if (openAdd) {
          document.getElementById('addUserModal').style.display = 'flex';
          setTimeout(() => focusFirstError('addUserModal'), 0);
        }
        if (openEdit) {
          document.getElementById('editUserModal').style.display = 'flex';
          setTimeout(() => focusFirstError('editUserModal'), 0);
        }
      });
    /*]]>*/
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
      const labels  = /*[[${chartLabels}]]*/ [];
      const revenue = /*[[${chartRevenue}]]*/ [];
      const counts  = /*[[${chartCounts}]]*/ [];

      const ctx = document.getElementById('revenueChart').getContext('2d');
      const chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: '–î–æ—Ö–æ–¥, ‚ÇΩ',
            data: revenue,
            borderWidth: 2,
            tension: 0.25
          }, {
            label: '–ö–æ–ª-–≤–æ –∑–∞–∫–∞–∑–æ–≤',
            data: counts,
            borderWidth: 2,
            tension: 0.25,
            yAxisID: 'y2'
          }]
        },
        options: {
          responsive: true,
          interaction: { mode: 'index', intersect: false },
          scales: {
            y:  { title: { display: true, text: '–î–æ—Ö–æ–¥' } },
            y2: { position: 'right', title: { display: true, text: '–ó–∞–∫–∞–∑—ã' }, grid: { drawOnChartArea:false } }
          }
        }
      });
    /*]]>*/
</script>
<script>
    (function(){
      // –º–∞–ª–µ–Ω—å–∫–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞
      const help = document.createElement('div');
      help.style.cssText = 'position:fixed;right:16px;bottom:16px;background:#111827;color:#fff;padding:10px 12px;border-radius:10px;box-shadow:0 10px 20px rgba(0,0,0,.15);font:13px/1.3 system-ui;opacity:.9;z-index:9999';
      help.innerHTML =
        '<strong>–ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏</strong><div style="margin-top:6px">' +
        'g,1 ‚Äî –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è<br>' +
        'g,2 ‚Äî –≠–∫—Å–ø–æ—Ä—Ç CSV<br>' +
        '<div style="margin-top:6px">–°–ø—Ä–∞–≤–∫–∞: Shift+? ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å</div></div>';
      document.body.appendChild(help);

      let seq = 0;          // 0 ‚Äî –∂–¥—ë–º g, 1 ‚Äî –∂–¥—ë–º —Ü–∏—Ñ—Ä—É
      let timer = null;

      function clickById(id){
        const el = document.getElementById(id);
        if (!el) return;
        // –µ—Å–ª–∏ —ç—Ç–æ <a> ‚Äî –ø–µ—Ä–µ—Ö–æ–¥–∏–º –ø–æ —Å—Å—ã–ª–∫–µ, –∏–Ω–∞—á–µ click()
        if (el.tagName === 'A' && el.href) { window.location.assign(el.href); }
        else { el.click(); }
      }

      function handleAction(n){
        switch(n){
          case '1': clickById('btnAddUser'); break;   // –æ—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
          case '2': clickById('btnExportCsv'); break; // —Å–∫–∞—á–∞—Ç—å CSV
        }
      }

      document.addEventListener('keydown', (e) => {
        // –ø–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É ‚Äî Shift+?
        if (e.shiftKey && (e.key === '?' || e.key === '/')) {
          e.preventDefault();
          help.style.display = (help.style.display === 'none') ? '' : 'none';
          return;
        }

        // –Ω–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º, –∫–æ–≥–¥–∞ –ø–µ—á–∞—Ç–∞—é—Ç –≤ –∏–Ω–ø—É—Ç–∞—Ö/—Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –æ–±–ª–∞—Å—Ç—è—Ö/—Å–µ–ª–µ–∫—Ç–∞—Ö
        const tag = (e.target.tagName || '').toLowerCase();
        const typing = ['input','textarea','select'].includes(tag) || e.target.isContentEditable;
        if (typing) return;

        // –¥–≤—É—Ö—É–¥–∞—Ä–Ω—ã–µ g,1..2
        if (seq === 0) {
          if (e.key.toLowerCase() === 'g' && !e.ctrlKey && !e.altKey && !e.metaKey) {
            e.preventDefault();
            seq = 1;
            clearTimeout(timer);
            timer = setTimeout(()=> seq = 0, 1500);
          }
        } else { // –∂–¥—ë–º —Ü–∏—Ñ—Ä—É
          const k = e.key;
          if (['1','2'].includes(k)) {
            e.preventDefault();
            clearTimeout(timer);
            seq = 0;
            handleAction(k);
            return;
          }
          seq = 0;
        }

        // –æ–¥–Ω–æ—É–¥–∞—Ä–Ω—ã–µ –¥—É–±–ª–∏–∫–∞—Ç—ã: Alt+Shift+U (user), Alt+Shift+E (export)
        if (e.altKey && e.shiftKey && !e.ctrlKey && !e.metaKey) {
          if (e.key.toLowerCase() === 'u') { e.preventDefault(); clickById('btnAddUser'); return; }
          if (e.key.toLowerCase() === 'e') { e.preventDefault(); clickById('btnExportCsv'); return; }
        }
      }, {passive:false});

      console.log('[admin hotkeys] ready');
    })();
</script>
<script>
    // --- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ª–æ–≥–æ–≤ ---
    function filterLogs(query) {
        query = (query || '').toLowerCase();
        const rows = document.querySelectorAll('#logsTbody tr');
        rows.forEach(tr => {
            const text = tr.innerText.toLowerCase();
            tr.style.display = text.includes(query) ? '' : 'none';
        });
    }

    function initLogsSorting() {
        const table = document.querySelector('.logs-table');
        if (!table) return;

        const headers = table.querySelectorAll('thead th[data-sort]');
        const tbody = document.getElementById('logsTbody');

        headers.forEach(th => {
            th.addEventListener('click', () => {
                const field = th.dataset.sort;
                const current = th.classList.contains('sort-asc') ? 'asc'
                              : th.classList.contains('sort-desc') ? 'desc'
                              : null;
                const next = current === 'asc' ? 'desc' : 'asc';

                // —Å–±—Ä–æ—Å–∏—Ç—å –∫–ª–∞—Å—Å—ã –Ω–∞ –¥—Ä—É–≥–∏—Ö –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö
                headers.forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
                th.classList.add(next === 'asc' ? 'sort-asc' : 'sort-desc');

                const rows = Array.from(tbody.querySelectorAll('tr'));
                const idx = Array.from(th.parentNode.children).indexOf(th);

                rows.sort((a, b) => {
                    let av, bv;
                    if (field === 'date') {
                        av = Number(a.querySelector('.log-date').dataset.ts || '0');
                        bv = Number(b.querySelector('.log-date').dataset.ts || '0');
                    } else {
                        av = (a.children[idx].innerText || '').trim().toLowerCase();
                        bv = (b.children[idx].innerText || '').trim().toLowerCase();
                    }
                    if (av === bv) return 0;
                    const res = av > bv ? 1 : -1;
                    return next === 'asc' ? res : -res;
                });

                tbody.append(...rows);
            });
        });
    }

    function initLogDetailsToggle() {
        document.querySelectorAll('.log-details').forEach(el => {
            el.addEventListener('click', () => {
                el.classList.toggle('expanded');
            });
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        initLogsSorting();
        initLogDetailsToggle();
    });
</script>


</body>
</html>